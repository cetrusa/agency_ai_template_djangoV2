{% comment %}
Modal System · modal_form.html

Modal base para formularios.

Context esperado:
- modal_title: str
- modal_size: sm|md|lg|xl
- modal_backdrop_close: bool (recomendado False cuando hay formulario)

- form_action: url
- form: Django Form
- submit_label, cancel_label

HTMX:
- hx-post a form_action
- hx-target="#modal-host" + hx-swap="innerHTML" para re-render completo (errores incluidos)
  (mantiene header/footer consistentes sin fragmentos extra)

Éxito recomendado (backend):
- Responder 204 con headers:
  - HX-Trigger: {"crudChanged": true, "modalClose": true}
  - (opcional) devolver alerts OOB aparte.
{% endcomment %}

{% extends 'partials/modals/modal_base.html' %}

{% block modal_body %}
  {% if modal_state == 'loading' %}
    {% include 'partials/modals/_modal_loading.html' %}
  {% elif modal_state == 'error' %}
    {% include 'partials/modals/_modal_error.html' %}
  {% else %}
    <form method="post"
          action="{{ form_action }}"
          class="ds-modal-form"
          hx-post="{{ form_action }}"
          hx-target="#modal-host"
          hx-swap="innerHTML"
          hx-indicator="#modal-indicator">

      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
          {{ form.non_field_errors|striptags }}
        </div>
      {% endif %}

      <div class="ds-modal-form__grid">
        {% for field in form %}
          <div class="mb-3">
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}

            {% if field.help_text %}
              <div class="form-text">{{ field.help_text }}</div>
            {% endif %}

            {% if field.errors %}
              <div class="text-danger small mt-1">{{ field.errors|striptags }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </form>
  {% endif %}
{% endblock %}

{% block modal_footer %}
  {% include 'partials/modals/modal_footer_actions.html' with
      cancel_label=cancel_label|default:'Cancelar'
      submit_label=submit_label|default:'Guardar'
      submit_form_selector='.ds-modal-form'
  %}
{% endblock %}
